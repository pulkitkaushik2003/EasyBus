<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Checkout - Razorpay Payment</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body style="background:linear-gradient(180deg,#081120,#0b1526);color:#e6edf6;font-family:Inter,Arial;">

<div class="container" style="max-width:1080px;margin:0 auto;padding:24px;">

    <!-- Header -->
    <div class="header d-flex justify-content-between align-items-center mb-4">
        <h1>BusLink - Booking #<span th:text="${bookingId}"></span></h1>
        <div class="text-success"><i class="fas fa-shield-alt"></i> Secure Payment</div>
    </div>

    <!-- Booking Summary -->
    <div class="mt-4 bg-dark p-4 rounded">
        <h3><i class="fas fa-ticket-alt"></i> Booking Summary</h3>
        <div class="row mt-3">
            <div class="col-md-6">
                <p><strong>Route:</strong> <span th:text="${routeName}"></span></p>
                <p><strong>Seats:</strong> <span th:text="${seats}"></span></p>
            </div>
            <div class="col-md-6">
                <p><strong>Total Fare:</strong> <span class="text-success">₹<span th:text="${totalFare}"></span></span></p>
                <p><strong>Booking ID:</strong> <span th:text="${bookingId}"></span></p>
            </div>
        </div>
    </div>

    <!-- Payment Methods -->
    <div class="mt-4 card bg-dark text-white p-4">
        <h3><i class="fas fa-credit-card"></i> Choose Payment Method</h3>
        
        <div class="row mt-4">
            <div class="col-md-4 mb-3">
    <a th:href="@{'/api/payonline?bookingId=' + ${bookingId}}" 
   class="btn btn-primary w-100 h-100 py-3 text-center">
    <i class="fas fa-credit-card fa-2x mb-2"></i><br>
    <strong>Credit/Debit Card</strong><br>
    <small>Visa, Mastercard, RuPay</small>
</a>

</div>            
            
            <!-- Razorpay Payment Button -->
        <div class="text-center mt-4">
            <button id="rzp-button1" class="btn btn-success btn-lg px-5 py-3" onclick="initiateRazorpayPayment()">
                <i class="fas fa-lock"></i> Pay ₹<span th:text="${totalFare}"></span> with Razorpay
            </button>
            
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" style="display:none;" class="text-center mt-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Processing your payment...</p>
        </div>
    </div>

    <!-- Security Badges -->
    <div class="text-center mt-4">
        <small class="text-muted">
            <i class="fas fa-shield-alt"></i> Your payment information is encrypted and secure
        </small>
    </div>
</div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        var bookingId = /*[[${bookingId}]]*/ '';
        var totalFare = /*[[${totalFare}]]*/ 0;
        var routeName = /*[[${routeName}]]*/ '';
        var userEmail = /*[[${userEmail}]]*/ 'user@example.com';
        var userName = /*[[${userName}]]*/ 'User';
        /*]]>*/

    function initiateRazorpayPayment() {
        // Show loading spinner
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('rzp-button1').disabled = true;

        // Create Razorpay order
        fetch('/api/razorpay/create-order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ bookingId: bookingId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('rzp-button1').disabled = false;
                return;
            }

            var options = {
                "key": data.key,
                "amount": data.amount,
                "currency": data.currency,
                "name": "BusLink",
                "description": "Bus Ticket Booking",
                "image": "https://your-domain.com/logo.png",
                "order_id": data.orderId,
                "handler": function (response) {
                    // Payment successful
                    verifyPayment(response);
                },
                "prefill": {
                    "name": userName,
                    "email": userEmail,
                    "contact": ""
                },
                "notes": {
                    "booking_id": bookingId,
                    "route_name": routeName
                },
                "theme": {
                    "color": "#3399cc"
                },
                "modal": {
                    "ondismiss": function() {
                        document.getElementById('loadingSpinner').style.display = 'none';
                        document.getElementById('rzp-button1').disabled = false;
                    }
                }
            };

            var rzp1 = new Razorpay(options);
            rzp1.open();
            document.getElementById('loadingSpinner').style.display = 'none';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to create payment order. Please try again.');
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('rzp-button1').disabled = false;
        });
    }

    function verifyPayment(response) {
        fetch('/api/razorpay/verify-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                razorpay_order_id: response.razorpay_order_id,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_signature: response.razorpay_signature,
                booking_id: bookingId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.href = '/api/booking-confirmation?bookingId=' + bookingId;
            } else {
                alert('Payment verification failed: ' + data.error);
                window.location.href = '/my-bookings';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Payment verification failed. Please contact support.');
            window.location.href = '/my-bookings';
        });
    }
</script>

</body>
</html>
